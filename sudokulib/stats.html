<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Stats</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<script type="module">
		const body = document.createElement('pre');
		body.style.textAlign = "left";
		body.style.position = "absolute";
		body.style.top = "16px";
		body.style.left = "16px";
		body.style.margin = "0px";
		document.body.appendChild(body);

		const search = new URLSearchParams(window.location.search);
		const mode = parseInt(search.get("mode") ?? -1);
		const tablex = (search.get("tablex") === null) ? false : true;

		const percentage = (number, total, precision) => {
			const percent = (number * 100 / total).toFixed(precision);
			return percent.padStart(precision + 3, "0") + "%";
		};

		const appendSpace = () => {
			const line = document.createElement('br');
			body.appendChild(line);
		};
		const appendLine = (text) => {
			const line = document.createElement('DIV');
			line.appendChild(document.createTextNode(text));
			body.appendChild(line);
		};

		const startTime = performance.now();

		const modeText = (data) => {
			if (mode > 1) {
				const time = Math.round((performance.now() - startTime) / 1000);
				data += `\n${Math.floor(time / 60)}m ${time % 60}s\n\n`;
			}
			body.appendChild(document.createTextNode(data));
		}
		const mode3 = (data) => {
			const fixed = 2;
			if (tablex) {
				let total = 0;
				for (const puzzle of data) total += puzzle.totalCount;

				appendLine(`--- Total ${total.toLocaleString()}`);
				appendSpace();

				let max = 0;
				let min = 0;
				for (const puzzle of data) {
					const simple = puzzle.simple;
					const candidateVisual = puzzle.candidateVisual;
					const candidate = puzzle.candidate;
					const candidateMinimal = puzzle.candidateMinimal;
					const unsolvable = puzzle.unsolvable;
					const totalCount = puzzle.totalCount;
					// let runningTotal = 0;

					// runningTotal += simple;
					// let runningPercent = percentage(runningTotal, totalCount, fixed);
					// let percent = percentage(simple, totalCount, fixed);
					// let number = simple.toLocaleString();
					// appendLine(`Simple: ${runningPercent} (${percent}) ${number}`);

					// runningTotal += candidateVisual;
					// runningPercent = percentage(runningTotal, totalCount, fixed);
					// percent = percentage(candidateVisual, totalCount, fixed);
					// number = candidateVisual.toLocaleString();
					// appendLine(`Visual: ${runningPercent} (${percent}) ${number}`);

					// const strategy = candidate + candidateMinimal;
					// runningTotal += strategy;
					// runningPercent = percentage(runningTotal, totalCount, fixed);
					// const percentCandidate = percentage(strategy + candidateVisual, totalCount, fixed);
					// const minPercent = percentage(candidateMinimal, strategy, fixed);
					// percent = percentage(strategy, totalCount, fixed);
					// number = strategy.toLocaleString();
					// appendLine(`Strategy: ${runningPercent} (${percent} of ${percentCandidate}) (${minPercent} minimal) ${number}`);

					// runningTotal += unsolvable;
					// runningPercent = percentage(runningTotal, totalCount, fixed);
					// percent = percentage(unsolvable, totalCount, fixed);
					// number = unsolvable.toLocaleString();
					// appendLine(`Unsolvable: ${runningPercent} (${percent}) ${number}`);

					if (min === 0) min = unsolvable;
					else min = Math.min(min, unsolvable);
					max = Math.max(max, unsolvable);
					let percent = percentage(unsolvable, totalCount, fixed);
					appendLine(`Unsolvable: ${percent}`);
				}

				let percent = percentage(min, 100000, fixed);
				appendLine(`Min: ${percent}`);
				percent = percentage(max, 100000, fixed);
				appendLine(`Max: ${percent}`);

				const time = Math.round((performance.now() - startTime) / 1000);
				appendLine(`${Math.floor(time / 60)}m ${time % 60}s`);
				appendSpace();

				return;
			}
			const simple = data.simple;
			const candidateVisual = data.candidateVisual;
			const candidate = data.candidate;
			const candidateMinimal = data.candidateMinimal;
			const unsolvable = data.unsolvable;
			const totalCount = data.totalCount;
			let runningTotal = 0;

			appendLine(`--- Total ${totalCount.toLocaleString()}`);
			appendSpace();

			runningTotal += simple;
			let runningPercent = percentage(runningTotal, totalCount, fixed);
			let percent = percentage(simple, totalCount, fixed);
			let number = simple.toLocaleString();
			appendLine(`Simple: ${runningPercent} (${percent}) ${number}`);

			runningTotal += candidateVisual;
			runningPercent = percentage(runningTotal, totalCount, fixed);
			percent = percentage(candidateVisual, totalCount, fixed);
			number = candidateVisual.toLocaleString();
			appendLine(`Visual: ${runningPercent} (${percent}) ${number}`);

			const strategy = candidate + candidateMinimal;
			runningTotal += strategy;
			runningPercent = percentage(runningTotal, totalCount, fixed);
			const percentCandidate = percentage(strategy + candidateVisual, totalCount, fixed);
			const minPercent = percentage(candidateMinimal, strategy, fixed);
			percent = percentage(strategy, totalCount, fixed);
			number = strategy.toLocaleString();
			appendLine(`Strategy: ${runningPercent} (${percent} of ${percentCandidate}) (${minPercent} minimal) ${number}`);

			runningTotal += unsolvable;
			runningPercent = percentage(runningTotal, totalCount, fixed);
			percent = percentage(unsolvable, totalCount, fixed);
			number = unsolvable.toLocaleString();
			appendLine(`Unsolvable: ${runningPercent} (${percent}) ${number}`);

			appendSpace();
			const time = Math.round((performance.now() - startTime) / 1000);
			appendLine(`${Math.floor(time / 60)}m ${time % 60}s`);
			appendSpace();
		}

		const url = './statsFeed.php' + window.location.search;
		fetch(url, { cache: "no-store" }).then(response => {
			if (mode >= 0 && mode <= 2) response.text().then((text) => { modeText(text); });
			if (mode === 3) response.json().then((json) => { mode3(json); });
			if (mode >= 4 && mode <= 7) response.text().then((text) => { modeText(text); });
		});
	</script>

</head>

<body></body>

</html>